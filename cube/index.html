<html>
<head>
<meta charset="utf-8">
<style>
h1 { text-align: center; }
#resultRoot { width: 100%; height: 50%; display: flex; }
#resultMain { width: 100%; border: 0; overflow: hidden; background-color: #888; }
#scriptRoot { width: 100%; height: 40%; display: flex; }
#scriptMain { width: 100%; }
#buttonRoot { width: 100%; height: 10%; display: flex; }
#runButton { width: 90%; margin: 12px 6px; }
#editButton { width: 10%; margin: 12px 6px; display: none; }
#fullButton { width: 10%; margin: 12px 6px; display: block; }
</style>
</head>
<body>
<div id="resultRoot">
<iframe id="resultMain">
</iframe>
</div>
<div id="buttonRoot">
<button id="runButton">Run</button>
<button id="editButton">^</button>
<button id="fullButton">v</button>
</div>
<div id="scriptRoot">
<textarea id="scriptMain">
// Define counts of sprites.
var number = 3;

// Define maximum of sprite faces.
var maximum = 6;

// Define timeout counts.
var timeout = 100;

// Initialize common modules.
var count = new cube.Count();
var screen = new cube.Screen("screen");
var input = new cube.Input(screen);

// Load image for sprite.
var image = new cube.Sprite("image");
image.LoadImage("cube.png");
await image.WaitLoadingImage();
image.SetFrame(0, 0, 192, 192);

// Clone to create sprites.
var sprites = [];
var angles = [];
for (var i = 0; i < number; i++) {
	sprites[i] = image.Clone();
}

// Main loop.
var randoms = null;
var results = null;
var angle = 0;
while (true) {

	// Update sprites.
	if (results == null) {

		// Set random faces.
		randoms = [];
		for (var i = 0; i < number; i++) {
			randoms[i] = count.Random(maximum) + 1;
			var fx = 192 * Math.floor((randoms[i] - 1) % 4);
			var fy = 192 * Math.floor((randoms[i] - 1) / 4);
			sprites[i].SetFrame(fx, fy, 192, 192);
		}

		// Decrease timeout count.
		timeout--;

		// Set result faces.
		input.UpdateDirs();
		if (timeout <= 0 || input.Dirs(true)) {
			results = randoms;
			randoms = null;
		}
	}

	// Update sprite positions.
	screen.UpdateLen();
	for (var i = 0; i < number; i++) {
		sprites[i].SetScale(2.0 / (number + 1));
		sprites[i].SetPos(new cube.Vec(screen.len.x / (number + 1) * (i + 1), screen.len.y / 2));
	}

	// Update sprite angles.
	if (randoms != null) {
		angle = (angle + 20) % 360;
	} else if ((angle % 90) > 0) {
		angle = (angle + 10) % 360;
	}

	// Draw results.
	if (results != null) {
		screen.Print(results.reduce((a, b) => a + b) + "#" + number + "d" + maximum);
	} else {
		screen.Print("" + timeout);
	}

	// Draw sprites.
	for (var i = 0; i < number; i++) {
		sprites[i].SetAngle(angle);
		sprites[i].Enable(screen, true);
	}

	// Clear screen for next loop.
	await count.Wait(10);
	screen.Clear();
}
</textarea>
</div>
<script id="mainScript">

	// Edit screen button.
	var editButton = document.getElementById("editButton");

	// Edit screen button.
	var fullButton = document.getElementById("fullButton");

	// Run button.
	var runButton = document.getElementById("runButton");

	// Edit screen button event.
	editButton.addEventListener("click", () => {

		// Half result panes.
		var result = document.getElementById("resultRoot");
		result.style.height = "50%";
		result.style.display = "flex";

		// Open script panes.
		var script = document.getElementById("scriptRoot");
		script.style.height = "40%";
		script.style.display = "flex";

		// Enable hide button.
		var button = document.getElementById("buttonRoot");
		editButton.style.display = "none";
		fullButton.style.display = "block";
    });

	// Full screen button event.
	fullButton.addEventListener("click", () => {

		// Open result panes.
		var result = document.getElementById("resultRoot");
		result.style.height = "90%";
		result.style.display = "flex";

		// Close script panes.
		var script = document.getElementById("scriptRoot");
		script.style.height = "0%";
		script.style.display = "none";

		// Enable edit button.
		var button = document.getElementById("buttonRoot");
		editButton.style.display = "block";
		fullButton.style.display = "none";
    });

	// Run event.
	var runEvent = () => {

		// Create result panes.
		var result = document.getElementById("resultRoot");
		var resultMain = document.createElement("iframe");
		resultMain.setAttribute("id", "resultMain");

		// Get script panes.
		var scriptMain = document.getElementById("scriptMain");

		// Add result window.
		while ( result.firstChild ) {
			result.removeChild(result.firstChild);
		}
		result.appendChild(resultMain);

		// Add scripts to result pane after load iframe html.
		resultMain.contentWindow.addEventListener("load", () => {

			// Set result window style.
			resultMain.contentWindow.document.documentElement.style.overflow = "hidden";

			// Add common script to result pane.
			var commonScript = document.createElement("script");
			commonScript.src = "cube-0.1.js";
			resultMain.contentWindow.document.body.appendChild(commonScript);

			// Add user script to result pane after load common script.
			commonScript.addEventListener("load", () => {
				var userScript = document.createElement("script");
				userScript.innerHTML = "(async()=>{" + scriptMain.value + "})();";
				resultMain.contentWindow.document.body.appendChild(userScript);
			});
		});
	};

	// Run button event.
	runButton.addEventListener("click", runEvent);

	// On load event.
	window.addEventListener("load", runEvent);
</script>
</body>
</html>
