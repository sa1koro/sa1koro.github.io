var cube=cube||{};cube.version="0.1.200806+0",cube.Vec=class{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}Clone(){return new cube.Vec(this.x,this.y,this.z)}ToString(){return this.x.toString()+","+this.y.toString()+","+this.z.toString()}Deserialize(t){t.replace(/(\d+),(\d+),(\d+)/,(t,e,s,i)=>{this.x=e?Number(e):0,this.y=s?Number(s):0,this.z=i?Number(i):0})}Serialize(){return this.ToString()}IsZero(){return 0==this.x&&0==this.y&&0==this.z}LenSq(){return this.x*this.x+this.y*this.y+this.z*this.z}Add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}Sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}Mul(t){return this.x=Math.round(this.x*t),this.y=Math.round(this.y*t),this.z=Math.round(this.z*t),this}Div(t){return 0!=t?(this.x=Math.round(this.x/t),this.y=Math.round(this.y/t),this.z=Math.round(this.z/t)):(this.x=0,this.y=0,this.z=0),this}Neg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}Eq(t){return this.x==t.x&&this.y==t.y&&this.z==t.z}Ne(t){return this.x!=t.x||this.y!=t.y||this.z!=t.z}},cube.Vec.zero=new cube.Vec(0,0,0),cube.Vec.x=new cube.Vec(1,0,0),cube.Vec.y=new cube.Vec(0,1,0),cube.Vec.z=new cube.Vec(0,0,1),cube.Dirs=class{constructor(t=-1){t>=0&&t<cube.Dirs.bit_max?this.flags=1<<t:this.flags=0}Clone(){let t=new cube.Dirs;return t.flags=this.flags,t}Deserialize(t){this.flags=isFinite(t)?Number(t):0}Serialize(){return""+this.flags}ToString(){let t="";for(let e=0;e<cube.Dirs.bit_max;++e)t+=this.Test(new cube.Dirs(e))?e:"-";return t}ToVec(){const t=[cube.Vec.z.Clone().Neg(),cube.Vec.x.Clone().Neg(),cube.Vec.y.Clone().Neg(),cube.Vec.y,cube.Vec.x,cube.Vec.z];let e=new cube.Vec(0,0,0);for(let s=0;s<cube.Dirs.bit_max;++s)this.Test(new cube.Dirs(s))&&e.Add(t[s]);return e}Clear(){this.flags=0}IsEmpty(){return 0==this.flags}Count(){count=0;for(let t=0;t<Dirs.bit_max;++t)this.Test(new cube.Dirs(t))&&(count+=1);return count}Add(t){this.flags|=t.flags}Sub(t){this.flags&=~t.flags}Test(t){return(this.flags&t.flags)>0}Near(){return(1&this.flags)>0}Far(){return(32&this.flags)>0}Right(){return(16&this.flags)>0}Left(){return(2&this.flags)>0}Down(){return(4&this.flags)>0}Up(){return(8&this.flags)>0}},cube.Dirs.bit_max=6,cube.Dirs.empty=new cube.Dirs,cube.Dirs.near=new cube.Dirs(0),cube.Dirs.far=new cube.Dirs(5),cube.Dirs.right=new cube.Dirs(4),cube.Dirs.left=new cube.Dirs(1),cube.Dirs.down=new cube.Dirs(2),cube.Dirs.up=new cube.Dirs(3),cube.Board=class{constructor(t){let e=null!=t&&t.length>0?t[0].length:0,s=null!=t?t.length:0;this.values=new Array(s),this.objects=new Array(s);for(let i=0;i<s;++i){this.values[i]=new Array(e),this.objects[i]=new Array(e);for(let s=0;s<e;++s)this.values[i][s]=t[i]?t[i][s]:0,this.objects[i][s]=null}}Clone(){let t=new Clone,e=this.Width(),s=this.Height();t.values=new Array(s),t.objects=new Array(s);for(let i=0;i<s;++i){t.values[i]=new Array(e),t.objects[i]=new Array(e);for(let s=0;s<e;++s)t.values[i][s]=this.values[i][s],t.objects[i][s]=this.objects[i][s]}return t}Width(){return null!=this.values&&this.values.length>0?this.values[0].length:0}Height(){return null!=this.values?this.values.length:0}HasGrid(t,e){return t>=0&&t<this.Width()&&e>=0&&e<this.Height()}SetValue(t,e,s){this.HasGrid(t,e)&&(this.values[e][t]=s)}Value(t,e){return this.HasGrid(t,e)?this.values[e][t]:cube.Board.invalid_value}RemoveObjects(){let t=this.Width(),e=this.Height();for(let s=0;s<e;++s)for(let e=0;e<t;++e)this.objects[s][e]=null}AddObject(t,e,s){this.HasGrid(e,s)&&(this.objects[s][e]=t)}ToString(){let t=this.Width(),e=this.Height(),s="";for(let i=0;i<e;++i){for(let e=0;e<t;++e)null!=this.objects[i][e]?s+=" "+this.objects[i][e]:s+=" "+this.Value(e,i);s+="\n"}return s}},cube.Board.invalid_value=-1,cube.Piece=class{constructor(t,e=null){this.pos=t,this.dirs=new cube.Dirs,this.movement=e}Clone(){let t=new cube.Piece;return t.pos=this.pos.Clone(),t.dirs=this.dirs.Clone(),t.movement=this.movement,t}},cube.Count=class{constructor(t=0){this.time=Date.now(),this.seed=0!=t?t:this.time}async Wait(t){t>0&&await new Promise(e=>setTimeout(e,t))}Time(t=!1){let e=Date.now()-this.time;return this.time=Date.now(),t?e:this.time}Random(t){return this.seed=this.seed^this.seed<<13,this.seed=this.seed^this.seed>>>17,this.seed=this.seed^this.seed<<15,Math.abs(this.seed%t)}Seed(){return this.seed}SetSeed(t){this.seed=0!=t?t:Date.now()}},cube.Params=class{constructor(t=null,e=null){this.name=t,this.Deserialize(e)}Keys(){return Object.keys(this.keyvalues)}Value(t){return this.keyvalues[t]}SetValue(t,e){null!=e?this.keyvalues[t]=e:delete this.keyvalues[t]}Deserialize(t){if(this.keyvalues={},null!=t)if(t.includes("&"))t.split("&").forEach(t=>{let e=t.split("=");null!=e[0]&&null!=e[1]&&(this.keyvalues[e[0]]=e[1])});else{let e=t.split("=");null!=e[0]&&null!=e[1]&&(this.keyvalues[e[0]]=e[1])}}Serialize(){let t=[];for(let e in this.keyvalues)null!=e&&null!=this.keyvalues[e]&&t.push(e+"="+this.keyvalues[e]);return t.join("&")}async WaitUpdatingValue(){for(;!this.updated;)await new Promise(t=>setTimeout(t,10))}},cube.InitialParams=class extends cube.Params{constructor(t=null,e=null){if(null==e){let t=window.location.search;null!=t&&""!=t&&(e=t.slice(1))}super(t,e)}Update(){let t=super.Serialize();if(null!=t){let e="?"+t;window.history.replaceState(null,"",e)}}},cube.StorageParams=class extends cube.Params{constructor(t=null,e=null){null==e&&(e=localStorage.getItem(t)),super(t,e)}Save(){let t=super.Serialize();null!=t&&localStorage.setItem(this.name,t)}},cube.MessageParams=class extends cube.Params{constructor(t=null,e=null){super(t,e)}Send(t=null){let e=super.Serialize();null!=e&&(null!=t?t.postMessage(e,this.name?this.name:"*"):null!=window.parent&&window.parent.postMessage(e,this.name?this.name:"*"))}},cube.Screen=class{constructor(t=null){if(this.type=t,this.root=null,this.pos=new cube.Vec,this.len=new cube.Vec,null!=t){let e=document.getElementsByClassName(t);if(e.length>0)for(let t=0;t<e.length;++t)if(!cube.Screen.Manager().screens.includes(e[t])){this.root=e[t],cube.Screen.Manager().screens.push(this.root);break}}null==this.root&&(this.root=document.createElement("pre"),null!=t&&(this.root.setAttribute("class",t),this.root.style.width="100%",this.root.style.height="100%",this.root.style.margin="0",this.root.style.userSelect="none",document.body.appendChild(this.root),cube.Screen.Manager().screens.push(this.root)),this.pos.x=this.root.style.left,this.pos.y=this.root.style.top,this.len.x=this.root.clientWidth,this.len.y=this.root.clientHeight)}UpdateLen(){this.len.x=this.root.clientWidth,this.len.y=this.root.clientHeight}Print(t){null!=this.root&&this.root.appendChild(document.createTextNode(t+"\n"))}Clear(){null!=this.root&&(this.root.textContent=null)}static Manager(){return null==this.manager&&(this.manager={},this.manager.screens=[],this.manager.images={}),this.manager}},cube.Sprite=class{constructor(t=null){this.type=t,this.root=null,this.sprite=null,this.image_type=null,this.anime_type=null,this.pos=null,this.len=null,this.dir=null,this.angle=0,this.scale=1,this.alpha=1,this.root=document.createElement("div"),this.sprite=document.createElement("div"),this.root.appendChild(this.sprite),null!=t&&this.sprite.setAttribute("class",t)}Clone(){let t=new cube.Sprite(this.type);return t.SetImage(this.image_type),t.SetFrame(-this.sprite.style.backgroundPositionX,-this.sprite.style.backgroundPositionY,this.sprite.style.width,this.sprite.style.height),t.SetAnime(this.anime_type),t.SetPos(this.pos),t.SetDir(this.dir),t.SetAngle(this.angle),t.SetScale(this.scale),t.SetAlpha(this.alpha),t}LoadImage(t){if(null!=this.root){let e=new Image;e.onload=(()=>{let s=document.createElement("style");document.head.appendChild(s);let i=cube.Screen.Manager().images[this.type]?cube.Screen.Manager().images[this.type]+1:1;cube.Screen.Manager().images[this.type]=i;let n=this.type+"_"+i,l="."+n+'{background-image:url("'+t+'");width:'+e.naturalWidth+";height:"+e.naturalHeight+";}";s.sheet.insertRule(l),this.len=new cube.Vec(e.naturalWidth,e.naturalHeight),this.SetImage(n)}),e.src=t}}async WaitLoadingImage(){for(;null==this.image_type;)await new Promise(t=>setTimeout(t,10))}SetImage(t){null!=this.root&&null!=this.sprite&&(this.sprite.classList.contains(t)||(this.sprite.classList.remove(this.image_type),this.sprite.classList.add(t),this.image_type=t))}SetFrame(t,e,s,i){if(null!=this.root&&null!=this.sprite){this.len=new cube.Vec(s,i),this.sprite.style.width=s,this.sprite.style.height=i,this.sprite.style.backgroundPosition=-t+" "+-e;let n=this.sprite.style.naturalWidth/s,l=this.sprite.style.naturalHeight/i;this.sprite.style.backgroundSize=n+" "+l;let h=s*(this.scale-1)/2,r=i*(this.scale-1)/2;this.root.style.width=s,this.root.style.height=i,this.root.style.marginLeft=h,this.root.style.marginRight=h,this.root.style.marginTop=r,this.root.style.marginBottom=r}}SetAnime(t){null!=this.root&&null!=this.sprite&&(this.sprite.classList.contains(t)||(this.sprite.classList.remove(this.anime_type),this.sprite.classList.add(t),this.anime_type=t))}Enable(t,e){null!=this.root&&null!=t.root&&(e?t.root.contains(this.root)||t.root.appendChild(this.root):t.root.contains(this.root)&&t.root.removeChild(this.root))}IsInRect(t){if(null!=this.root&&null!=t){let e=this.root.getBoundingClientRect();return t.x>e.left&&t.x<e.right&&t.y>e.top&&t.y<e.bottom}return!1}SetPos(t){if(null!=this.root)if(this.pos=t,null!=t){this.root.style.position="fixed";let t=parseInt(this.sprite.style.width)*this.scale/2,e=parseInt(this.sprite.style.height)*this.scale/2;this.root.style.top=this.pos.y-t,this.root.style.left=this.pos.x-e}else this.root.style.position="relative"}SetDir(t){if(null!=this.root&&(this.dir=t,null!=t)){const t=180/Math.PI;this.angle=Math.atan2(this.dir.y,this.dir.x)*t,this.root.style.transform="scale("+this.scale+")rotate("+this.angle+"deg)"}}SetAngle(t){null!=this.root&&(this.dir=null,this.angle=t,this.root.style.transform="scale("+this.scale+")rotate("+this.angle+"deg)")}SetScale(t){if(null!=this.root){this.scale=t,this.root.style.transform="scale("+this.scale+")rotate("+this.angle+"deg)";let e=parseInt(this.sprite.style.width)*(t-1)/2,s=parseInt(this.sprite.style.height)*(t-1)/2;this.root.style.marginLeft=e,this.root.style.marginRight=e,this.root.style.marginTop=s,this.root.style.marginBottom=s}}SetAlpha(t){null!=this.root&&(this.alpha=t,this.root.style.opacity=this.alpha)}},cube.Input=class{constructor(t=null){if(this.dirs=[null,null],this.key_code=null,this.points=null,this.key_time=0,this.tap_time=0,this.flick_time=0,this.down_event=!1,this.up_event=!1,this.touches=null,null!=t&&null!=t.root){let e=t.root;document.addEventListener("keyup",t=>this.OnKeyUp(t)),document.addEventListener("keydown",t=>this.OnKeyDown(t)),e.addEventListener("mousedown",t=>this.OnMouseDown(t)),e.addEventListener("mousemove",t=>this.OnMouseMove(t)),document.addEventListener("mouseup",t=>this.OnMouseUp(t)),e.addEventListener("touchstart",t=>this.OnTouch(t),{passive:!1}),e.addEventListener("touchmove",t=>this.OnTouch(t),{passive:!1}),e.addEventListener("touchend",t=>this.OnTouch(t)),e.addEventListener("touchcancel",t=>this.OnTouch(t)),document.addEventListener("scroll",t=>this.OnScroll(t))}}Clone(){let t=new cube.Input;return null!=this.dirs[0]&&(t.dirs[0]=this.dirs[0].Clone()),null!=this.dirs[1]&&(t.dirs[1]=this.dirs[1].Clone()),null!=this.points&&(t.points=[],null!=this.points[0]&&(t.points[0]=this.points[0].Clone()),null!=this.points[1]&&(t.points[1]=this.points[1].Clone())),t}KeyCodeToDirs(t){return 39==t?cube.Dirs.right.Clone():38==t?cube.Dirs.up.Clone():37==t?cube.Dirs.left.Clone():40==t?cube.Dirs.down.Clone():new cube.Dirs}PointVecToDirs(t){const e=Math.PI/4,s=3*Math.PI/4;let i=Math.atan2(t.y,t.x);return-e<i&&i<=e?cube.Dirs.right.Clone():-s<i&&i<=-e?cube.Dirs.up.Clone():s<i||i<=-s?cube.Dirs.left.Clone():e<i&&i<=s?cube.Dirs.down.Clone():new cube.Dirs}SerializeParams(){let t=new cube.Params;return null!=this.dirs[0]&&t.SetValue("dirs0",this.dirs[0].Serialize()),null!=this.dirs[1]&&t.SetValue("dirs1",this.dirs[1].Serialize()),null!=this.points&&(null!=this.points[0]&&t.SetValue("points0",this.points[0].Serialize()),null!=this.points[1]&&t.SetValue("points1",this.points[1].Serialize())),t}UpdateDirs(){this.UpdateDirsByScreen(1e3,2500,.5)}UpdateDirsByParams(t){null!=t.Value("dirs0")&&(this.dirs[0]=new cube.Dirs,this.dirs[0].Deserialize(t.Value("dirs0"))),null!=t.Value("dirs1")&&(this.dirs[1]=new cube.Dirs,this.dirs[1].Deserialize(t.Value("dirs1"))),null!=t.Value("points0")||null!=t.Value("points1")?(this.points=[],null!=t.Value("points0")&&(this.points[0]=new cube.Vec,this.points[0].Deserialize(t.Value("points0"))),null!=t.Value("points1")&&(this.points[1]=new cube.Vec,this.points[1].Deserialize(t.Value("points1")))):this.points=null}UpdateDirsByScreen(t,e,s){let i=Date.now();if(this.key_code<=0&&null==this.points)this.dirs[0]=null,this.key_time=i,this.tap_time=i,this.flick_time=i;else if(this.key_code>0)this.dirs[0]=this.KeyCodeToDirs(this.key_code),this.key_time<=i-t&&this.dirs[0].Add(cube.Dirs.far);else if(null!=this.points){let n=this.points[1].Clone().Sub(this.points[0]);e<=0||n.LenSq()>=e?(this.dirs[0]=this.PointVecToDirs(n),this.tap_time=i-t,(this.flick_time<=i-t||this.points[1].z-this.points[0].z>=s)&&(this.dirs[0].Add(cube.Dirs.far),this.flick_time=i-t)):(this.dirs[0]=new cube.Dirs,(this.tap_time<=i-t||this.points[1].z-this.points[0].z>=s)&&(this.dirs[0].Add(cube.Dirs.far),this.tap_time=i-t,this.flick_time=i-t))}this.down_event?(this.dirs[1]=null,this.down_event=!1):this.up_event?(this.dirs[1]=this.dirs[0],this.up_event=!1):null!=this.dirs[1]&&(this.dirs[0]=null,this.dirs[1]=null,this.key_code=null,this.points=null)}Dirs(t=!1){return null!=this.dirs[t?0:1]?this.dirs[t?0:1].Clone():null}Point(t=!1){return null!=this.points?this.points[t?0:1].Clone():null}SetDirs(t){this.dirs[0]=t,this.dirs[1]=t}OnKeyDown(t){(t=null!=t?t:window.event).preventDefault(),this.key_code=t.keyCode,this.down_event=!0}OnKeyUp(t){(t=null!=t?t:window.event).preventDefault(),this.key_code=t.keyCode,this.up_event=!0}UpdatePointOnDown(t){this.points=[t.Clone(),t.Clone()],this.down_event=!0}UpdatePointOnMove(t){null!=this.points&&(this.points[1]=t.Clone())}UpdatePointOnUp(t){null!=this.points&&(this.points[1]=t.Clone(),this.up_event=!0)}OnMouseDown(t){(t=null!=t?t:window.event).preventDefault();let e=new cube.Vec(t.pageX,t.pageY);this.UpdatePointOnDown(e)}OnMouseMove(t){(t=null!=t?t:window.event).preventDefault();let e=new cube.Vec(t.pageX,t.pageY);this.UpdatePointOnMove(e)}OnMouseUp(t){(t=null!=t?t:window.event).preventDefault();let e=new cube.Vec(t.pageX,t.pageY);this.UpdatePointOnUp(e)}OnTouch(t){if((t=null!=t?t:window.event).preventDefault(),null==this.touches&&t.touches.length>0){this.touches=[];let e=new cube.Vec;for(let s=0;s<t.touches.length;++s)this.touches.push(t.touches[s]),e.Add(new cube.Vec(t.touches[s].pageX,t.touches[s].pageY,t.touches[s].force));e.Div(t.touches.length),this.UpdatePointOnDown(e)}else{let e=[],s=new cube.Vec,i=0;for(let n=0;n<t.touches.length;++n){e.push(t.touches[n]);for(let e=0;e<this.touches.length;++e)t.touches[n].identifier==this.touches[e].identifier&&(s.x+=t.touches[n].pageX-this.touches[e].pageX,s.y+=t.touches[n].pageY-this.touches[e].pageY,s.z+=t.touches[n].force-this.touches[e].force,i+=1)}if(null!=this.points)if(i>0){let t=this.points[1].Add(s.Clone().Div(i));this.UpdatePointOnMove(t),this.touches=e}else{let t=this.points[1];this.UpdatePointOnUp(t),this.touches=null}}}OnScroll(t){(t=null!=t?t:window.event).preventDefault()}};